# kubaaa1.yml - Kubernetes Cluster Connection Test
# Generated by Python script on 2025-07-23T17:44:57.191198
# This Ansible playbook tests connectivity to Kubernetes clusters
---
- name: kubaaa1 - Connect to Kubernetes Cluster
  hosts: localhost
  gather_facts: false
  vars:
    kubeconfig_default: '{{ ansible_env.HOME }}/.kube/config'
    kubeconfig_windows: '{{ ansible_env.USERPROFILE }}\.kube\config'
  tasks:
  - name: Display kubaaa1 banner
    debug:
      msg:
      - === kubaaa1 - Kubernetes Cluster Connection Test ===
      - 'Timestamp: {{ ansible_date_time.iso8601 }}'
      - 'Target: {{ inventory_hostname }}'
      - ======================================================
  - name: Detect operating system
    set_fact:
      is_windows: '{{ ansible_os_family == "Windows" }}'
  - name: Set kubeconfig path for Linux/macOS
    set_fact:
      kubeconfig_path: '{{ lookup("env", "KUBECONFIG") or kubeconfig_default }}'
    when: not is_windows
  - name: Set kubeconfig path for Windows
    set_fact:
      kubeconfig_path: '{{ lookup("env", "KUBECONFIG") or kubeconfig_windows }}'
    when: is_windows
  - name: Display kubeconfig path being used
    debug:
      msg: 'Using kubeconfig: {{ kubeconfig_path }}'
  - name: Check if kubeconfig file exists
    stat:
      path: '{{ kubeconfig_path }}'
    register: kubeconfig_stat
  - name: Fail if kubeconfig file not found
    fail:
      msg:
      - 'KUBECONFIG file not found at: {{ kubeconfig_path }}'
      - Please ensure the kubeconfig file exists and is readable.
      - You can set the KUBECONFIG environment variable to specify a different path.
    when: not kubeconfig_stat.stat.exists
  - name: Check if kubectl is available
    command: kubectl version --client=true
    register: kubectl_version_check
    ignore_errors: true
    changed_when: false
  - name: Fail if kubectl is not available
    fail:
      msg:
      - kubectl is not installed or not in PATH.
      - Please install kubectl and ensure it is available in your system PATH.
      - 'Installation guide: https://kubernetes.io/docs/tasks/tools/'
    when: kubectl_version_check.rc != 0
  - name: Display kubectl version
    debug:
      msg: 'kubectl version: {{ kubectl_version_check.stdout_lines[0] }}'
    when: kubectl_version_check.rc == 0
  - name: Test Kubernetes cluster connection
    command: kubectl get nodes --kubeconfig "{{ kubeconfig_path }}"
    register: kubectl_nodes_result
    ignore_errors: true
    changed_when: false
  - name: Display connection success message
    debug:
      msg:
      - ✓ Successfully connected to Kubernetes cluster!
      - '{{ kubectl_nodes_result.stdout }}'
    when: kubectl_nodes_result.rc == 0
  - name: Get cluster information
    command: kubectl cluster-info --kubeconfig "{{ kubeconfig_path }}"
    register: kubectl_cluster_info
    ignore_errors: true
    changed_when: false
    when: kubectl_nodes_result.rc == 0
  - name: Display cluster information
    debug:
      msg:
      - 'Cluster Information:'
      - '{{ kubectl_cluster_info.stdout }}'
    when: kubectl_nodes_result.rc == 0 and kubectl_cluster_info.rc == 0
  - name: Get current context
    command: kubectl config current-context --kubeconfig "{{ kubeconfig_path }}"
    register: kubectl_current_context
    ignore_errors: true
    changed_when: false
    when: kubectl_nodes_result.rc == 0
  - name: Display current context
    debug:
      msg: 'Current context: {{ kubectl_current_context.stdout }}'
    when: kubectl_nodes_result.rc == 0 and kubectl_current_context.rc == 0
  - name: Display connection failure message
    debug:
      msg:
      - ✗ Failed to connect to Kubernetes cluster
      - 'Error output: {{ kubectl_nodes_result.stderr }}'
      - 'Please check:'
      - '  - Cluster is running and accessible'
      - '  - Network connectivity to cluster API server'
      - '  - Kubeconfig credentials are valid and not expired'
      - '  - RBAC permissions for cluster access'
      - '  - Firewall settings allowing cluster communication'
    when: kubectl_nodes_result.rc != 0
  - name: Fail if unable to connect to Kubernetes cluster
    fail:
      msg:
      - Unable to connect to Kubernetes cluster.
      - Please review the error messages above and troubleshoot accordingly.
    when: kubectl_nodes_result.rc != 0
  - name: Display success summary
    debug:
      msg:
      - === kubaaa1 Connection Test Summary ===
      - ✓ Kubeconfig found and accessible
      - ✓ kubectl is available and working
      - ✓ Successfully connected to Kubernetes cluster
      - ✓ Cluster information retrieved successfully
      - ===========================================
    when: kubectl_nodes_result.rc == 0
